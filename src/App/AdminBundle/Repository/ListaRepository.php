<?php

namespace App\AdminBundle\Repository;

/**
 * ListaRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ListaRepository extends \Doctrine\ORM\EntityRepository
{
	public function queryAll(array $valores = array(), $user)
	  {
	        $em = $this->getEntityManager();
	        $qb = $em->createQueryBuilder();
	        $qb->select('a');
	        $qb->from('AdminBundle:Lista', 'a');
	        $qb->where("a.Usuario = ?1");
	        $qb->setParameter(1,$user->getId());


	        if (array_key_exists("nombre", $valores))
	        {
	            $valores['nombre'] = trim($valores['nombre']);
	            if (strlen($valores['nombre'])>0)
	            {
	                $qb->Andwhere($qb->expr()->like("a.nombre", "?2"));
	                $qb->setParameter(2,"%".$valores['nombre']."%");
	            }			
	        }

	        $consulta = $qb->getQuery();
	        return $consulta;
	  }

	  public function check($menu, $lista)
	{
		$qp = $this->createQueryBuilder('l')->select('l')->where('l.id = :lista')->setParameter('lista', $lista->getId())->innerJoin('l.menus','m')->andWhere('m.id = :menu')->setParameter('menu', $menu->getId());
		return $qp->getQuery()->getOneOrnullResult();
	}

	     public function listTable($lista)
    {
        return $this->getEntityManager()
            ->createQueryBuilder()
            ->select('l.id','i.nombre as ingrediente', 'o.cantidad as cantidad', 'i.unidadMedida as unidad', 'o.comprado as estado','o.id as idOrden' )
                ->from('AdminBundle:Lista', 'l')
                ->where('l.id = :id')
                ->setParameter('id',$lista->getId())
                ->innerJoin('l.ordenescompras','o')
                ->innerJoin('o.Ingrediente','i')
            ->getQuery()
            ->getResult();
    }

    public function getNumeroListasFecha()
	{
		$qp = $this->createQueryBuilder('l')->select('l.fechaCreacion','count(l.id) as frecuenciaListas')->groupBy('l.fechaCreacion')->addOrderBy('l.fechaCreacion', 'ASC');;
		
		return $qp->getQuery()->getResult();
	}

	public function getNumeroLista()
	{
		$qp = $this->createQueryBuilder('l')->select('count(l.id)');
		
		return $qp->getQuery()->getSingleScalarResult();
	}


}
